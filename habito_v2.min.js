import gsap from "https://cdn.jsdelivr.net/npm/gsap@3.12.2/index.js";
import { ScrollTrigger } from "https://cdn.jsdelivr.net/npm/gsap@3.12.2/ScrollTrigger.js";
import { Flip } from "https://cdn.jsdelivr.net/npm/gsap@3.12.2/Flip.js";
import { CustomEase } from "https://cdn.jsdelivr.net/npm/gsap@3.12.2/CustomEase.js";
import barbaCore from "https://cdn.skypack.dev/@barba/core@2.10.3";
import Lenis from "https://cdn.jsdelivr.net/npm/@studio-freight/lenis@1.0.19/dist/lenis.mjs";
import SplitType from "https://cdn.jsdelivr.net/npm/split-type@0.3.3/+esm";
import Swiper from "https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.mjs";

function initGSAP() {
  gsap.registerPlugin(CustomEase, Flip, ScrollTrigger);
  CustomEase.create("primary-ease", "0.62, 0.05, 0.01, 0.99"),
    CustomEase.create("primary-ease-out", "0.17,0.84,0.44,1"),
    ScrollTrigger.defaults({
      markers: false,
    });
  gsap.defaults({
    duration: 1.25,
  });
}

function initLenis() {
  if (Webflow.env("editor") === undefined) {
    // Inisialisasi Lenis
    const lenis = new Lenis();

    // Sinkronisasi Lenis dengan GSAP ScrollTrigger
    lenis.on("scroll", ScrollTrigger.update);

    // Tambahkan ke GSAP ticker agar animasi tetap smooth
    gsap.ticker.add((time) => {
      lenis.raf(time * 1000); // GSAP memberikan waktu dalam detik, perlu dikonversi ke milidetik
    });

    // Matikan lag smoothing agar tidak ada delay di scroll animasi
    gsap.ticker.lagSmoothing(0);

    return lenis;
  }
}

function resetWebflow(e) {
  const t = $(new DOMParser().parseFromString(e.next.html, "text/html")).find("html");
  $("html").attr("data-wf-page", t.attr("data-wf-page")),
    window.Webflow && window.Webflow.destroy(),
    window.Webflow && window.Webflow.ready(),
    window.Webflow && window.Webflow.require("ix2").init(),
    $(".w--current").removeClass("w--current"),
    $("a").each(function () {
      $(this).attr("href") === window.location.pathname && $(this).addClass("w--current");
    }),
    t.find("[data-barba-script]").each(function () {
      let e = $(this).text();
      if (e.includes("DOMContentLoaded")) {
        const t = e.replace(/window\.addEventListener\("DOMContentLoaded",\s*\(\s*event\s*\)\s*=>\s*{\s*/, "");
        e = t.replace(/\s*}\s*\);\s*$/, "");
      }
      const t = document.createElement("script");
      (t.type = "text/javascript"), $(this).attr("src") && (t.src = $(this).attr("src")), (t.text = e), document.body.appendChild(t).remove();
    });
}

function disableCurrentLinks() {
  document.addEventListener("click", function (e) {
    const t = e.target.closest("a");
    if (t) {
      if (window.location.href.split("#")[0] === t.href.split("#")[0]) return void e.preventDefault();
    }
  });
}

function initSplitText() {
  const typeSplit1 = new SplitType("[split-1]", {
    types: "chars",
    tagName: "span",
  });

  const typeSplit2 = new SplitType("[split-2]", {
    types: "lines, words, chars",
    tagName: "div",
  });

  $("[split-2] .line").each(function () {
    $(this).wrap('<div class="line-wrap"></div>');
  });
}

function initMarquee() {
  gsap.to("[marquee]", {
    xPercent: -100,
    ease: "linear",
    duration: 50,
    repeat: -1,
  });
}

function initTrMarquee() {
  function e(e, t) {
    const r = typeof e;
    return "string" !== typeof t || "" === t.trim() ? e : ("true" === t && "boolean" === r) || (("false" !== t || "boolean" !== r) && (isNaN(t) && "string" === r ? t : isNaN(t) || "number" !== r ? e : +t));
  }
  $("[tr-marquee-element='component']").each(function () {
    function t(e) {
      d = e;
      const t = {
          value: 1,
        },
        r = gsap.timeline({
          onUpdate: () => g.timeScale(t.value),
        });
      e
        ? (r.fromTo(
            t,
            {
              value: m,
            },
            {
              value: 0,
              duration: 0.5,
            }
          ),
          n.addClass("is-paused"))
        : (r.fromTo(
            t,
            {
              value: 0,
            },
            {
              value: m,
              duration: 0.5,
            }
          ),
          n.removeClass("is-paused"));
    }
    let r = $(this),
      o = r.find("[tr-marquee-element='panel']"),
      a = r.find("[tr-marquee-element='triggerhover']"),
      n = r.find("[tr-marquee-element='triggerclick']"),
      i = e(100, r.attr("tr-marquee-speed")),
      l = e(!1, r.attr("tr-marquee-vertical")),
      s = e(!1, r.attr("tr-marquee-reverse")),
      c = e(!1, r.attr("tr-marquee-scrolldirection")),
      u = e(!1, r.attr("tr-marquee-scrollscrub")),
      p = -100,
      m = 1,
      d = !1;
    s && (p = 100);
    const g = gsap.timeline({
      repeat: -1,
      onReverseComplete: () => g.progress(1),
    });
    l
      ? ((i = o.first().height() / i),
        g.fromTo(
          o,
          {
            yPercent: 0,
          },
          {
            yPercent: p,
            ease: "none",
            duration: i,
          }
        ))
      : ((i = o.first().width() / i),
        g.fromTo(
          o,
          {
            xPercent: 0,
          },
          {
            xPercent: p,
            ease: "none",
            duration: i,
          }
        ));
    const f = {
      value: 1,
    };
    ScrollTrigger.create({
      trigger: "body",
      start: "top top",
      end: "bottom bottom",
      onUpdate: (e) => {
        if (!d && (c && m !== e.direction && ((m = e.direction), g.timeScale(e.direction)), u)) {
          let t = 0.006 * e.getVelocity();
          (t = gsap.utils.clamp(-20, 20, t)),
            gsap
              .timeline({
                onUpdate: () => g.timeScale(f.value),
              })
              .fromTo(
                f,
                {
                  value: t,
                },
                {
                  value: m,
                  duration: 0.5,
                }
              );
        }
      },
    }),
      window.matchMedia("(pointer: fine)").matches && (a.on("mouseenter", () => t(!0)), a.on("mouseleave", () => t(!1))),
      n.on("click", function () {
        $(this).hasClass("is-paused") ? t(!1) : t(!0);
      });
  });
}

function initScrollToTop(lenisInstance) {
  const btn = document.querySelector("[scroll-to-top]");
  if (!btn) return;

  btn.addEventListener("click", () => {
    lenisInstance.scrollTo(0, {
      duration: 1.2,
      easing: (t) => 1 - Math.pow(1 - t, 4),
    });
  });
}

function initReelsAnimation() {
  $(".about-wrapper").each(function () {
    const triggerElement = $(this);
    const targetElement = $(".reels-wrap");

    gsap
      .timeline({
        scrollTrigger: {
          trigger: triggerElement,
          start: "top 70%",
          end: "bottom 50%",
          scrub: 1,
        },
      })
      .fromTo(targetElement, { width: "100%", y: "0svh" }, { width: "25%", y: "167svh" });
  });
}

function aboutReelsAnimation() {
  $(".section-hero-group").each(function () {
    const triggerElement = $(this);
    const targetElement = $(".reels-wrap");

    gsap
      .timeline({
        scrollTrigger: {
          trigger: triggerElement,
          start: "top top",
          end: "90% bottom",
          scrub: 1,
        },
      })
      .fromTo(targetElement, { y: "-88svh", x: "70svw", width: "25%" }, { y: "0", x: "0", width: "100%" });
  });
}

function initReelsFlip() {
  $(document).ready(function () {
    const $reelsWrap = $(".reels-wrap");
    const $originalParent = $reelsWrap.parent();
    const $targetParent = $(".about-reels");

    ScrollTrigger.create({
      trigger: ".section.is-about",
      start: "top 30%",
      end: "bottom 50%",
      onEnter: () => moveReels($targetParent),
      onLeaveBack: () => moveReels($originalParent),
    });
  });
}

function moveReels($newParent) {
  const state = Flip.getState($(".reels-wrap")[0]);
  $newParent.append($(".reels-wrap"));
  Flip.from(state, { duration: 1.5, ease: "none" });
}

function initWorkSectionAnimation() {
  const mm = gsap.matchMedia();

  mm.add("(min-width: 768px)", () => {
    $(".work-head-block").each(function () {
      const triggerElement = $(this);
      const targetElement = $(".section.is-work");

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "bottom 75%",
            end: "bottom bottom",
            scrub: 1,
          },
        })
        .fromTo(targetElement, { backgroundColor: "#CBEB3A", color: "#111" }, { backgroundColor: "#111", color: "#fff" });

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "top top",
            end: "bottom 50%",
            scrub: 1,
          },
        })
        .from(".work-head-wrap", { scale: 1.75 });
    });
  });

  mm.add("(max-width: 767px)", () => {
    $(".work-head-block").each(function () {
      const triggerElement = $(this);
      const targetElement = $(".section.is-work");

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "bottom 90%",
            end: "bottom bottom",
            scrub: 1,
          },
        })
        .fromTo(targetElement, { backgroundColor: "#CBEB3A", color: "#111" }, { backgroundColor: "#111", color: "#fff" });

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "top top",
            end: "bottom 50%",
            scrub: 1,
          },
        })
        .from(".work-head-wrap", { scale: 1 });
    });
  });
}

function initBrandingAnimation() {
  const mm = gsap.matchMedia();

  mm.add("(min-width: 768px)", () => {
    $(".section.is-branding").each(function () {
      const triggerElement = $(this);

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "top top",
            end: "80% bottom",
            scrub: 1,
          },
        })
        .fromTo(".branding-head", { scale: 0.55 }, { scale: 1 })
        .fromTo(".branding-head-wrap", { scale: 1.6 }, { scale: 1 }, 0.0);

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "10% top",
            end: "80% bottom",
            scrub: 1,
          },
        })
        .fromTo(".section-nav", { opacity: 0 }, { opacity: 1 })
        .fromTo("[branding-img]", { width: "0em" }, { width: "7.5em" })
        .fromTo("[text-wrap]", { x: "-0.75em" }, { x: "0em" })
        .from(".branding-head-wrap", { yPercent: 35 }, { yPercent: 0 });
    });
  });

  mm.add("(max-width: 767px)", () => {});
}

function initPartnerAccordion() {
  const mm = gsap.matchMedia();

  mm.add("(min-width: 768px)", () => {
    $(".partner-item").each(function (index) {
      const $item = $(this);
      const $clientImg = $item.find(".client-img");
      const $clientName = $item.find(".client-name");
      const $text = $item.find(".partner-item-content");

      // Jika ini adalah elemen pertama, buat jadi aktif
      if (index === 0) {
        $item.addClass("active");
        $text.show(); // Menampilkan konten tanpa animasi slide
        gsap.set($clientImg, { scale: 1 });
        gsap.set($clientName, { x: 0 });
      } else {
        gsap.set($clientImg, { scale: 0 });
        gsap.set($clientName, { x: -52 });
        $text.hide(); // Sembunyikan konten lainnya
      }

      // Hover Animation
      $item.hover(
        function () {
          if (!$(this).hasClass("active")) {
            gsap.to($clientImg, { scale: 1, duration: 0.3, ease: "power2.out" });
            gsap.to($clientName, { x: 0, duration: 0.3, ease: "power2.out" });
          }
        },
        function () {
          if (!$(this).hasClass("active")) {
            gsap.to($clientImg, { scale: 0, duration: 0.3, ease: "power2.out" });
            gsap.to($clientName, { x: -52, duration: 0.3, ease: "power2.out" });
          }
        }
      );

      // Click Event for Accordion
      $item.on("click", function () {
        const isActive = $(this).hasClass("active");

        // Reset semua item lain
        $(".partner-item").removeClass("active");
        $(".partner-item-content").stop(true, true).slideUp();
        gsap.to($(".client-img"), { scale: 0, duration: 0.3, ease: "power2.out" });
        gsap.to($(".client-name"), { x: -52, duration: 0.3, ease: "power2.out" });

        // Toggle current item
        if (!isActive) {
          $(this).addClass("active");
          $text.stop(true, true).slideDown();
          gsap.to($clientImg, { scale: 1, duration: 0.3, ease: "power2.out" });
          gsap.to($clientName, { x: 0, duration: 0.3, ease: "power2.out" });
        }
      });
    });
  });

  mm.add("(max-width: 767px)", () => {
    $(".partner-item").each(function (index) {
      const $item = $(this);
      const $text = $item.find(".partner-item-content");

      // Jika ini adalah elemen pertama, buat jadi aktif
      if (index === 0) {
        $item.addClass("active");
        $text.show(); // Menampilkan konten tanpa animasi slide
      } else {
        $text.hide(); // Sembunyikan konten lainnya
      }

      // Click Event for Accordion
      $item.on("click", function () {
        const isActive = $(this).hasClass("active");

        // Reset semua item lain
        $(".partner-item").removeClass("active");
        $(".partner-item-content").stop(true, true).slideUp();

        // Toggle current item
        if (!isActive) {
          $(this).addClass("active");
          $text.stop(true, true).slideDown();
        }
      });
    });
  });
}

function initFaqAccordion() {
  $(".faq-item").each(function (index) {
    const $item = $(this);
    const $text = $item.find(".faq-item-text");

    // Jika ini adalah elemen pertama, buat jadi aktif
    if (index === 0) {
      $item.addClass("active");
      $text.show(); // Menampilkan konten tanpa animasi slide
    } else {
      $text.hide(); // Sembunyikan konten lainnya
    }

    // Click Event for Accordion
    $item.on("click", function () {
      const isActive = $(this).hasClass("active");

      // Reset semua item lain
      $(".faq-item").removeClass("active");
      $(".faq-item-text").stop(true, true).slideUp();

      // Toggle current item
      if (!isActive) {
        $(this).addClass("active");
        $text.stop(true, true).slideDown();
      }
    });
  });
}

function initServiceSectionAnimation() {
  const mm = gsap.matchMedia();

  mm.add("(min-width: 768px)", () => {
    $(".section.is-service").each(function () {
      const triggerElement = $(this);

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "top 80%",
            end: "bottom top",
            scrub: 1,
          },
        })
        .fromTo(".service-head", { x: "50vw" }, { x: "-80vw" });

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "top 80%",
            end: "bottom bottom",
            scrub: 1,
          },
        })
        .from(".service-text .char", { y: "75svh", scale: 1.5, stagger: { each: 0.3 } });

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "top top",
            end: "bottom bottom",
            scrub: 1,
          },
        })
        .fromTo(".service-item", { y: "100svh", stagger: 0.2 }, { y: "0svh", stagger: 0.2 });
    });
  });

  mm.add("(max-width: 767px)", () => {
    $(".section.is-service").each(function () {
      const triggerElement = $(this);

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "top 30%",
            end: "45% top",
            scrub: 1,
          },
        })
        .fromTo(".service-head", { x: "80svw" }, { x: "-120svw" });

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "top 30%",
            end: "80% top",
            scrub: 1,
          },
        })
        .from(".service-text .char", { y: "75svh", scale: 1.5, stagger: { each: 0.3 } });

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "50% 50%",
            end: "bottom bottom",
            scrub: 1,
            markers: false,
          },
        })
        .fromTo(".service-item", { y: "120svh" }, { y: "0svh" });
    });
  });
}

function initReviewAnimation() {
  const mm = gsap.matchMedia();

  mm.add("(min-width: 768px)", () => {
    $(".section.is-client-review").each(function () {
      const triggerElement = $(this);

      gsap
        .timeline({
          scrollTrigger: {
            trigger: triggerElement,
            start: "40% bottom",
            end: "60% bottom",
            scrub: 1,
          },
        })
        .fromTo(triggerElement, { backgroundColor: "#F7F7F5", color: "#111" }, { backgroundColor: "#01565B", color: "#fff" });
    });
  });
}

function setupNavbarAnimation() {
  const navButton = $(".w-nav-button");
  const navMenu = $(".nav-mobile");
  const navLinks = $(".nav-link");
  const popupButton = $(".popup-btn");
  const bgPopup = $(".bg-popup");
  const { lenis } = window;
  const navText = $("[nav-mobile-text]");

  let isMenuOpen = false;

  function openMenu() {
    const t = gsap.timeline();

    t.to(
      navMenu,
      {
        duration: 1.25,
        y: "100svh",
        ease: "primary-ease",
      },
      0
    );

    t.fromTo(
      navLinks,
      {
        y: "120%",
      },
      {
        y: "0%",
        stagger: { amount: 0.2 },
        duration: 0.5,
        ease: "primary-ease-out",
      },
      0
    );

    t.fromTo(
      navText,
      {
        y: "120%",
      },
      {
        y: "0%",
        duration: 0.5,
        ease: "primary-ease-out",
      },
      0.6
    );

    $("body").addClass("menu-open");
    isMenuOpen = true;

    if (lenis && lenis.stop) lenis.stop();
  }

  function closeMenu() {
    const t = gsap.timeline();

    t.to(
      navMenu,
      {
        duration: 1.25,
        y: "0svh",
        ease: "primary-ease",
      },
      0.2
    );

    t.fromTo(
      navLinks,
      {
        y: "0%",
      },
      {
        y: "120%",
        stagger: { amount: 0.2, from: "end" },
        duration: 0.5,
        ease: "primary-ease-out",
      },
      0
    );

    t.fromTo(
      navText,
      {
        y: "0%",
      },
      {
        y: "120%",
        duration: 0.5,
        ease: "primary-ease-out",
      },
      0.5
    );

    $("body").removeClass("menu-open");
    isMenuOpen = false;

    if (lenis && lenis.start) lenis.start();
  }

  function toggleMenu() {
    if ($(window).width() < 768) {
      isMenuOpen ? closeMenu() : openMenu();
    }
  }

  // Event listeners
  navButton.on("click", toggleMenu);
  popupButton.on("click", toggleMenu);
  bgPopup.on("click", () => isMenuOpen && closeMenu());
  navLinks.on("click", closeMenu);

  $(window).on("resize", () => {
    if ($(window).width() > 767) {
      closeMenu();
      gsap.set(navMenu, { clearProps: "all" });
    }
  });
}

function imgReveal() {
  gsap
    .timeline({
      scrollTrigger: {
        trigger: "[img-wrap]",
        start: "top 80%",
        end: "top top",
      },
    })
    .from(".img-block", { yPercent: -100, duration: 1.25, ease: "primary-ease-out" })
    .from("[img-wrap]", { scale: 1.2, duration: 1.25, ease: "primary-ease-out" });
}

function initHeadOverlay() {
  gsap
    .timeline({
      scrollTrigger: {
        trigger: ".section.is-about",
        start: "top bottom",
        end: "bottom top",
        scrub: 1,
      },
    })
    .to(".overlay", { opacity: 0.5 });
}

function initSectionOverlap() {
  gsap.utils.toArray("[data-overlap-previous]").forEach((e) => {
    const t = e.previousElementSibling;
    if (!t) return;
    const r = document.createElement("div");
    (r.className = "g_section-overlay"), t.appendChild(r);
    const o = () => window.innerHeight / 4,
      a = gsap.timeline({
        scrollTrigger: {
          trigger: e,
          start: "top bottom",
          end: "top top",
          scrub: !0,
          onRefresh: (e) => {
            e.end = `bottom+=${o()}px top`;
          },
        },
      });
    a.to(
      t,
      {
        y: () => o(),
        rotate: 0.001,
        ease: "none",
      },
      0
    ),
      a.to(
        r,
        {
          opacity: 0.5,
          ease: "none",
        },
        0
      ),
      ScrollTrigger.create({
        trigger: e,
        start: "top bottom",
        end: "top top",
        onEnter: () => {
          gsap.set(e, {
            zIndex: 1,
          }),
            gsap.set(t, {
              zIndex: 0,
            });
        },
        onLeaveBack: () => {
          gsap.set(e, {
            zIndex: "auto",
          }),
            gsap.set(t, {
              zIndex: "auto",
            });
        },
      });
  });
}

function initServiceOverlap() {
  gsap.utils.toArray("[data-service-overlap]").forEach((e) => {
    const t = e.previousElementSibling;
    if (!t) return;
    const r = document.createElement("div");
    (r.className = "g_section-overlay"), t.appendChild(r);
    const o = () => t.offsetHeight * 0.5,
      a = gsap.timeline({
        scrollTrigger: {
          trigger: e,
          start: "top bottom",
          end: "top top",
          scrub: !0,
          onRefresh: (e) => {
            e.end = `bottom+=${o()}px top`;
          },
        },
      });
    a.to(
      t,
      {
        y: () => o(),
        rotate: 0.001,
        ease: "none",
      },
      0
    ),
      a.to(
        r,
        {
          opacity: 0.5,
          ease: "none",
        },
        0
      ),
      ScrollTrigger.create({
        trigger: e,
        start: "top bottom",
        end: "top top",
        onEnter: () => {
          gsap.set(e, {
            zIndex: 1,
          }),
            gsap.set(t, {
              zIndex: 0,
            });
        },
        onLeaveBack: () => {
          gsap.set(e, {
            zIndex: "auto",
          }),
            gsap.set(t, {
              zIndex: "auto",
            });
        },
      });
  });
}

function reviewSwiper() {
  const swiper = new Swiper(".swiper.is-review", {
    direction: "horizontal",
    slidesPerView: 1,
    spaceBetween: 24,
    loop: true,
    speed: 400,
    navigation: {
      nextEl: ".swiper-btn-next",
      prevEl: ".swiper-btn-prev",
    },
  });
}

function linesAnimation() {
  $("[text-reveal]").each(function () {
    const triggerElement = $(this); // Elemen yang memicu animasi
    const lines = triggerElement.find(".line"); // Ambil semua line-wrap

    const tl = gsap.timeline({
      scrollTrigger: {
        trigger: triggerElement,
        start: "top 80%", // Mulai animasi saat elemen masuk viewport
      },
    });

    tl.from(lines, {
      yPercent: 110, // Geser ke bawah saat masuk
      stagger: 0.1, // Delay antar line
      duration: 1.25,
      ease: "primary-ease-out",
    });
  });
}

function leaveAnimation(e) {
  const t = document.querySelector(".transition-overlay"),
    r = gsap.timeline();
  return (
    gsap.set(t, {
      display: "block",
    }),
    "closed" !== navStatus && (setNavStatus("closing"), closeNav(navStatus, setNavStatus)),
    r
      .to(e, {
        opacity: 0.1,
        y: "-20svh",
        scale: 0.94,
        ease: "primary-ease",
      })
      .from(
        t,
        {
          autoAlpha: 0,
        },
        0
      ),
    r
  );
}

function enterAnimation(e) {
  const t = gsap.timeline({
    onComplete: () => {
      ScrollTrigger.refresh(),
        gsap.set(e, {
          clearProps: "transform",
        });
    },
  });
  return (
    t.from(e, {
      y: "100svh",
      ease: "primary-ease",
      duration: 1.25,
    }),
    t
  );
}

function handleMouseMove(event) {
  const heroTop = document.querySelector(".hero-top");
  const reelsWrap = document.querySelector(".reels-wrap");

  if (!heroTop || !reelsWrap) return;

  const heroRect = heroTop.getBoundingClientRect();
  const reelsRect = reelsWrap.getBoundingClientRect();

  const mouseX = event.clientX; // Posisi mouse di seluruh halaman
  const windowWidth = window.innerWidth; // Lebar viewport
  const maxMovement = heroRect.width - reelsRect.width; // Batas pergerakan dalam parent

  // Mengonversi posisi mouse ke dalam range pergerakan
  let targetX = (mouseX / windowWidth) * maxMovement;

  // Pastikan reels-wrap tidak keluar dari parent
  targetX = Math.max(0, Math.min(targetX, maxMovement));

  gsap.to(reelsWrap, {
    x: targetX,
    duration: 2,
    ease: "power3.out",
  });
}

function setupReelsModalTransition() {
  const trigger = document.querySelector(".reels-item-wrap");
  const modal = trigger.querySelector(".reels-modal");
  const targetWrap = document.querySelector(".reels-modal-wrap");
  const closeBtn = document.querySelector(".close-btn");
  const small = document.querySelector(".reels-small");
  const full = document.querySelector(".reels-full");

  let state;
  let isOpen = false;

  // Helper untuk memaksa pointer-events dengan !important
  function forcePointer(el, value = "auto") {
    el.style.setProperty("pointer-events", value, "important");
  }

  const openModal = () => {
    state = Flip.getState(modal);

    targetWrap.appendChild(modal);

    Flip.from(state, {
      duration: 1,
      ease: "primary-ease",
      absolute: true,
      scale: true,
      simple: true,

      onStart: () => {
        modal.classList.add("fullscreen");

        // Force pointer-events auto
        forcePointer(modal, "auto");
        forcePointer(targetWrap, "auto");

        // Transisi untuk .reels-small dan .reels-full
        gsap.to(small, {
          opacity: 0,
          zIndex: 0,
          duration: 0.3,
        });

        gsap.to(full, {
          opacity: 1,
          zIndex: 1,
          duration: 0.3,
        });
      },

      onComplete: () => {
        isOpen = true;
      },
    });
  };

  const closeModal = () => {
    state = Flip.getState(modal);

    trigger.appendChild(modal);

    Flip.from(state, {
      duration: 1,
      ease: "primary-ease",
      absolute: true,
      scale: true,
      simple: true,

      onStart: () => {
        // Reset pointer-events
        forcePointer(modal, "none");
        forcePointer(targetWrap, "none");

        // Balikin .reels-small dan .reels-full
        gsap.to(small, {
          opacity: 1,
          zIndex: 1,
          duration: 0.3,
        });

        gsap.to(full, {
          opacity: 0,
          zIndex: 0,
          duration: 0.3,
        });
      },

      onComplete: () => {
        modal.classList.remove("fullscreen");
        isOpen = false;
      },
    });
  };

  // Event listeners
  trigger.addEventListener("click", () => {
    if (!isOpen) openModal();
  });

  closeBtn.addEventListener("click", () => {
    if (isOpen) closeModal();
  });
}

// Tambahkan event listener setelah DOM siap
document.addEventListener("DOMContentLoaded", () => {
  const heroTop = document.querySelector(".hero-top");
  if (heroTop) {
    heroTop.addEventListener("mousemove", handleMouseMove);
  }
});

function initAllAnimations() {
  //const lenis = initLenis();

  initSplitText();
  initMarquee();
  initTrMarquee();
  //initScrollToTop(lenis);
  linesAnimation();

  // Home

  //initReelsAnimation();
  //aboutReelsAnimation();
  //initReelsFlip();
  //initWorkSectionAnimation();

  initServiceSectionAnimation();
  initPartnerAccordion();
  initFaqAccordion();
  reviewSwiper();
  setupNavbarAnimation();
  ScrollTrigger.matchMedia({
    "(min-width: 767px)": function () {
      initSectionOverlap();
      initHeadOverlay();
      document.addEventListener("mousemove", handleMouseMove);
      setupReelsModalTransition();
      initBrandingAnimation();
      initServiceOverlap();
    },
  });
}

function firstLoad() {
  const e = document.getElementById("loader"),
    t = gsap.timeline({
      onComplete: () => {
        e.remove();
      },
    });
  return (
    t.to(e, {
      y: "-100svh",
      duration: 1.25,
      ease: "primary-ease",
    }),
    t
  );
}

function initHomeAnimation() {
  const tl = gsap.timeline();
  const typeSplit = new SplitType("[load-split]", {
    types: "lines, words, chars",
    tagName: "span",
  });

  tl.from(
    "[hero-text] .char",
    {
      yPercent: 110,
      stagger: { amount: 0.4 },
      duration: 1.25,
      ease: "primary-ease-out",
    },
    0.4
  );
  tl.from("[hero-head] .char", { yPercent: 110, duration: 1.25, ease: "primary-ease" }, 0.2);
  tl.from("[hero-btn]", { yPercent: 50, opacity: 0, ease: "primary-ease", duration: 1.25 }, 0.6);
  tl.from(".reels-wrap", { scale: 0, ease: "primary-ease-out", duration: 1.25 }, 0.6);

  initWorkSectionAnimation();
}

function initWorkAnimation() {
  const tl = gsap.timeline();
  const typeSplit = new SplitType("[load-split]", {
    types: "lines, words, chars",
    tagName: "span",
  });

  tl.from(
    "[work-text] .char",
    {
      yPercent: 110,
      stagger: { amount: 0.4 },
      duration: 1.25,
      ease: "primary-ease-out",
    },
    0.4
  );
  tl.from("[work-head] .char", { yPercent: 110, duration: 1.25, ease: "primary-ease" }, 0.2);
  tl.from("[work-btn]", { yPercent: 50, opacity: 0, ease: "primary-ease", duration: 1.25 }, 0.6);
  tl.from("[work-reels]", { scale: 0, ease: "primary-ease-out", duration: 1.25 }, 0.6);
}

function initPriceAnimation() {
  const tl = gsap.timeline();
  const typeSplit = new SplitType("[load-split]", {
    types: "lines, words, chars",
    tagName: "span",
  });

  tl.from(
    "[pricing-text] .char",
    {
      yPercent: 110,
      stagger: { amount: 0.4 },
      duration: 1.25,
      ease: "primary-ease-out",
    },
    0.4
  );
  tl.from("[pricing-head] .char", { yPercent: 110, duration: 1.25, ease: "primary-ease" }, 0.2);
  tl.from("[pricing-btn]", { yPercent: 50, opacity: 0, ease: "primary-ease", duration: 1.25 }, 0.6);
  tl.from("[pricing-reels]", { scale: 0, ease: "primary-ease-out", duration: 1.25 }, 0.6);
}

function initAboutAnimation() {
  const tl = gsap.timeline();
  const typeSplit = new SplitType("[load-split]", {
    types: "lines, words, chars",
    tagName: "span",
  });

  tl.from(
    "[about-text] .char",
    {
      yPercent: 110,
      stagger: { amount: 0.4 },
      duration: 1.25,
      ease: "primary-ease-out",
    },
    0.4
  );
  tl.from("[about-head] .char", { yPercent: 110, duration: 1.25, ease: "primary-ease" }, 0.2);
  tl.from("[about-btn]", { yPercent: 50, opacity: 0, ease: "primary-ease", duration: 1.25 }, 0.6);
  tl.from(
    "[about-block]",
    {
      y: "6.0625em",
      ease: "primary-ease-out",
      duration: 1.25,
      stagger: {
        amount: 0.5, // jeda antar elemen
        from: "start", // bisa: "start", "end", "center", "edges", atau "random"
      },
    },
    0.4
  );
  tl.from(
    "[about-img]",
    {
      scale: 1.3,
      ease: "primary-ease-out",
      duration: 1.25,
    },
    0.4
  );

  initReviewAnimation();
}

function initServiceAnimation() {
  const tl = gsap.timeline();
  const typeSplit = new SplitType("[load-split]", {
    types: "lines, words, chars",
    tagName: "span",
  });

  tl.from(
    "[service-text] .char",
    {
      yPercent: 110,
      stagger: { amount: 0.4 },
      duration: 1.25,
      ease: "primary-ease-out",
    },
    0.4
  );
  tl.from("[service-head] .char", { yPercent: 110, duration: 1.25, ease: "primary-ease" }, 0.2);
  tl.from("[service-btn]", { yPercent: 50, opacity: 0, ease: "primary-ease", duration: 1.25 }, 0.6);
  tl.from(
    "[service-block]",
    {
      y: "6.0625em",
      ease: "primary-ease-out",
      duration: 1.25,
      stagger: {
        amount: 0.5, // jeda antar elemen
        from: "start", // bisa: "start", "end", "center", "edges", atau "random"
      },
    },
    0.4
  );
  tl.from(
    "[service-img]",
    {
      scale: 1.3,
      ease: "primary-ease-out",
      duration: 1.25,
    },
    0.4
  );
}

function initCareerAnimation() {
  const tl = gsap.timeline();
  const typeSplit = new SplitType("[load-split]", {
    types: "lines, words, chars",
    tagName: "span",
  });

  tl.from(
    "[career-text] .char",
    {
      yPercent: 110,
      stagger: { amount: 0.4 },
      duration: 1.25,
      ease: "primary-ease-out",
    },
    0.4
  );
  tl.from("[career-head] .char", { yPercent: 110, duration: 1.25, ease: "primary-ease" }, 0.2);
  tl.from("[career-btn]", { yPercent: 50, opacity: 0, ease: "primary-ease", duration: 1.25 }, 0.6);
  tl.from(
    "[career-block]",
    {
      y: "6.0625em",
      ease: "primary-ease-out",
      duration: 1.25,
      stagger: {
        amount: 0.5, // jeda antar elemen
        from: "start", // bisa: "start", "end", "center", "edges", atau "random"
      },
    },
    0.4
  );
  tl.from(
    "[career-img]",
    {
      scale: 1.3,
      ease: "primary-ease-out",
      duration: 1.25,
    },
    0.4
  );
}

function pageTransitionHome(e) {
  const t = gsap.timeline();
  return t.add(enterAnimation(e)).add(initHomeAnimation(e), 0.8), t;
}

function pageTransitionWork(e) {
  const t = gsap.timeline();
  return t.add(enterAnimation(e)).add(initWorkAnimation(e), 0.8), t;
}

function pageTransitionPrice(e) {
  const t = gsap.timeline();
  return t.add(enterAnimation(e)).add(initPriceAnimation(e), 0.8), t;
}

function pageTransitionService(e) {
  const t = gsap.timeline();
  return t.add(enterAnimation(e)).add(initServiceAnimation(e), 0.8), t;
}

function pageTransitionCareer(e) {
  const t = gsap.timeline();
  return t.add(enterAnimation(e)).add(initCareerAnimation(e), 0.8), t;
}

function pageTransitionAbout(e) {
  const t = gsap.timeline();
  return t.add(enterAnimation(e)).add(initAboutAnimation(e), 0.8), t;
}

function homeFirstLoad(e) {
  const t = gsap.timeline();
  return t.add(firstLoad()).add(initHomeAnimation(e), 0.8), t;
}

function initPageTransitions() {
  scroll = initLenis();
  const e = barbaCore;
  e.hooks.once(() => {
    initAllAnimations();
    disableCurrentLinks();
  }),
    e.hooks.beforeLeave((e) => {
      scroll.stop(), resetWebflow(e);
    }),
    e.hooks.enter((e) => {
      gsap.set(e.next.container, {
        position: "fixed",
        top: 0,
        left: 0,
        width: "100%",
        zIndex: 3,
      }),
        disableCurrentLinks();
    }),
    e.hooks.afterEnter(() => {
      window.scrollTo(0, 0);
    }),
    e.hooks.after((e) => {
      gsap.set(e.next.container, {
        position: "relative",
      }),
        initAllAnimations(),
        scroll.resize(),
        scroll.start(),
        ScrollTrigger.refresh();
    }),
    e.init({
      transitions: [
        {
          name: "to-home",
          to: {
            namespace: "home",
          },
          sync: !0,
          once({ next: e }) {
            homeFirstLoad(e.container);
          },
          async leave({ current: e }) {
            await leaveAnimation(e.container);
          },
          enter({ next: e }) {
            pageTransitionHome(e.container);
          },
        },
        {
          name: "to-work",
          to: {
            namespace: "work",
          },
          sync: !0,
          once({ next: e }) {
            firstLoad(), pageTransitionWork(e.container);
          },
          async leave({ current: e }) {
            await leaveAnimation(e.container);
          },
          enter({ next: e }) {
            pageTransitionWork(e.container);
          },
        },
        {
          name: "to-about",
          to: {
            namespace: "about",
          },
          sync: !0,
          once({ next: e }) {
            firstLoad(), pageTransitionAbout(e.container);
          },
          async leave({ current: e }) {
            await leaveAnimation(e.container);
          },
          enter({ next: e }) {
            pageTransitionAbout(e.container);
          },
        },
        {
          name: "to-pricing",
          to: {
            namespace: "pricing",
          },
          sync: !0,
          once({ next: e }) {
            firstLoad(), pageTransitionPrice(e.container);
          },
          async leave({ current: e }) {
            await leaveAnimation(e.container);
          },
          enter({ next: e }) {
            pageTransitionPrice(e.container);
          },
        },
        {
          name: "to-service",
          to: {
            namespace: "service",
          },
          sync: !0,
          once({ next: e }) {
            firstLoad(), pageTransitionService(e.container);
          },
          async leave({ current: e }) {
            await leaveAnimation(e.container);
          },
          enter({ next: e }) {
            pageTransitionService(e.container);
          },
        },
        {
          name: "to-career",
          to: {
            namespace: "career",
          },
          sync: !0,
          once({ next: e }) {
            firstLoad(), pageTransitionCareer(e.container);
          },
          async leave({ current: e }) {
            await leaveAnimation(e.container);
          },
          enter({ next: e }) {
            pageTransitionCareer(e.container);
          },
        },
        {
          name: "default",
          sync: !0,
          once({ next: e }) {
            firstLoad(), enterAnimation(e.container);
          },
          async leave({ current: e }) {
            await leaveAnimation(e.container);
          },
          enter({ next: e }) {
            enterAnimation(e.container);
          },
        },
      ],
    });
}

let mm = gsap.matchMedia(),
  navStatus = "closed";
const setNavStatus = (e) => {
  (navStatus = e), console.log(navStatus);
};
initGSAP(), initPageTransitions();
